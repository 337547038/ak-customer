import{_ as U}from"./index.vue_vue_type_script_setup_true_lang-lWq4qB80.js";import{d as j,l as a,m as H,O,e as x,o as C,r as c,g as p,h as f,i as le,D as S,E as oe,z as W,N as re,k as se,s as T,I as R,L as B,c as ne,q as ue,P as de,F as ce,f as E,v as $,t as ie,j as me}from"./index-D_PG1Bnj.js";import{v as m}from"./validate-BQpdx7O0.js";import{_ as pe}from"./index.vue_vue_type_script_setup_true_lang-CEYRMk56.js";import{_ as fe}from"./paymentForm.vue_vue_type_script_setup_true_lang-Dn8619BG.js";const ve=["src"],he=j({__name:"upload",props:{modelValue:{default:""}},emits:["update:modelValue"],setup(L,{emit:Y}){const r=L,V=Y,o=a([]),v=a(""),i=a(!1),F=H(()=>r.modelValue,()=>{if(r.modelValue){const l=r.modelValue.split(",");o.value=[],l.forEach(s=>{o.value.push({url:s})})}}),h=()=>{W(()=>{const l=o.value.length?o.value.map(s=>s.url).join(","):"";V("update:modelValue",l)})},w=l=>{S("uploadDel",{path:l.url}),h()},I=l=>{v.value=l.url,i.value=!0},D=l=>{const s=new FormData;s.append("file",l.file),S("upload",s).then(({data:b})=>{o.value.forEach(u=>{u.uid===l.file?.uid&&(u.url=b)}),h()}).catch(()=>{o.value.forEach((b,u)=>{b.uid===l.file?.uid&&o.value.splice(u,1)}),h(),oe.error(`${l.file.name}上传失败`)})};return O(()=>{F()}),(l,s)=>{const b=c("Plus"),u=c("el-icon"),_=c("el-upload"),y=c("el-dialog"),k=c("el-form-item");return C(),x(k,{style:{width:"100%"}},{default:p(()=>[f(_,{"file-list":o.value,"onUpdate:fileList":s[0]||(s[0]=d=>o.value=d),"http-request":D,"list-type":"picture-card","on-preview":I,"on-remove":w},{default:p(()=>[f(u,null,{default:p(()=>[f(b)]),_:1})]),_:1},8,["file-list"]),f(y,{modelValue:i.value,"onUpdate:modelValue":s[1]||(s[1]=d=>i.value=d)},{default:p(()=>[le("img",{"w-full":"",src:v.value,alt:"Preview Image"},null,8,ve)]),_:1},8,["modelValue"])]),_:1})}}}),ye=j({__name:"index",setup(L,{expose:Y}){const r=re("detailTabsProps",a({})),V=me(),o=se(),v=a(!1),i=a(),F=T(()=>r.value.isComponents?r.value.tabsName==="contract":o.userInfo?.hasChild),h=T(()=>!r.value.isComponents),w=a(),I=a(),D=a(),l=a([{label:"所属人员",prop:"userId",show:!1,search:{changeRefresh:!0,style:{width:"230px"},visible:F,render:"select",ajax:{api:"userChildList",data:{},label:"userName",value:"id"},clearable:!0}},{prop:"id",label:"ID",search:!1,width:50},{prop:"code",label:"合同编号"},{prop:"name",label:"合同名称"},{prop:"customerId",label:"客户名称",width:180,showOverflowTooltip:!0,formatter:e=>e.customerName,search:{render:"component",userId:I,visible:h,component:R(U)},show:h},{prop:"money",label:"合同金额",search:!1,width:110},{prop:"payment",label:"已收款项",search:!1,width:110},{prop:"contactId",label:"公司签约人",search:!1,formatter:e=>e.contactName,width:100},{prop:"startDate",label:"合同有效期",search:{render:"datePicker",type:"daterange",startPlaceholder:"开始时间",endPlaceholder:"结束时间",valueFormat:"YYYY-MM-DD"},formatter:e=>B(e.startDate,"{y}-{m}-{d}")+" / "+B(e.endDate,"{y}-{m}-{d}"),width:180},{prop:"creatDate",label:"创建时间",render:"date",search:!1,width:100},{prop:"status",label:"状态",render:"tag",replaceValue:{1:"待审核",2:"已确认",3:"未通过"},custom:{2:"success",3:"danger"},search:{render:"select",options:{1:"待审核",2:"已确认",3:"未通过"}},width:"90px"},{prop:"operate",label:"操作",render:"buttons",width:210,fixed:"right",buttons:[{label:"审核",attr:{type:"danger",text:!0},display:e=>o.userInfo?.hasChild&&e.userId!==o.userInfo?.id&&e.status===1,click:e=>{y(e,!0)}},{label:"收款",attr:{type:"success",text:!0},click:e=>{w.value.open(!1,e)}},{key:"edit",label:"详情",attr:{text:!0},click:e=>{y(e)}},{key:"del",label:"删除",attr:{text:!0}}],search:!1}]),s=(e,t,g)=>{e==="userId"&&o.userInfo?.hasChild&&(g.customerId=null,I.value=t)},b=(e,t)=>(e==="get"&&(t.startEndDate&&(t.startDate=t.startEndDate[0],t.endDate=t.startEndDate[1],delete t.startEndDate),r.value.customerId&&(t.customerId=r.value.customerId),t.userId=r.value.userId,V.query.search==="todo"&&(t.extend.search="child")),t),u=a(!1),_=a(!1),y=(e,t)=>{v.value=!1,_.value=!0,q.value="新增合同",e&&(q.value=t?"审批合同":"修改合同",u.value=!!t,W(()=>{I.value||(v.value=e.status===2),D.value=e.userId,k.value.getData({id:e.id}),M.value=e.customerId}))},k=a(),d=a({}),q=a("新增合同"),M=a(),z=a([{label:"客户名称",prop:"customerId",render:"component",component:R(U),visible:h,formItem:{rules:[m("required","客户名称不能为空","change")]},attr:{userId:D}},{label:"合同名称",prop:"name",formItem:{rules:[m("required","合同名称不能为空","change")]}},{label:"合同编码",prop:"code",formItem:{rules:[m("required","合同编码不能为空","change")]}},{label:"公司签约人",prop:"contactId",attr:{placeholder:"请输入联系人,可使用%",customerId:M,userId:D},render:"component",component:R(pe),formItem:{rules:[m("required","公司签约人不能为空","change")]}},{label:"合同金额",prop:"money",formItem:{rules:[m("required","合同金额不能为空","change"),m("money")]}},{label:"合同开始时间",prop:"startDate",render:"datePicker",attr:{valueFormat:"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD"},formItem:{rules:[m("required","合同开始时间不能为空","change")]}},{label:"合同结束时间",prop:"endDate",render:"datePicker",attr:{valueFormat:"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD"},formItem:{rules:[m("required","合同结束时间不能为空","change")]}},{label:"审核",prop:"status",render:"select",options:[{value:1,label:"待审核"},{value:2,label:"通过"},{value:3,label:"拒绝"}],visible:u},{label:"备注",prop:"remark",attr:{style:{width:"100%"},type:"textarea",rows:4}},{prop:"files",label:"合同附件",render:"scope",formItem:{rules:[{required:!0,message:"请输入合同附件"}]}}]),P=()=>{_.value=!1,d.value={},k.value.resetFields()},A=(e,t)=>(t==="add"&&r.value.isComponents&&(e.customerId=r.value.customerId),e),G=(e,t,g)=>(["add","update"].includes(g)&&(P(),i.value.getData()),e),J=(e,t,g)=>{e==="customerId"&&(g.contactId=null,M.value=t)},K=()=>{i.value.getData()},Q=e=>e.startDate<new Date&&e.endDate>new Date,N=()=>{i.value.getData()},X=H(()=>V.query,()=>{N()});return O(()=>{X()}),Y({getData:N}),(e,t)=>{const g=c("el-tag"),Z=c("el-alert"),ee=c("ak-form"),te=c("el-dialog");return C(),ne(ce,null,[f(de,{ref_key:"tableListRef",ref:i,pk:"id",columns:l.value,api:{list:"contractList",del:"contractDel"},"control-btn":[{key:"add",click:()=>{y()}}],onFormFieldChange:s,"auto-load":!ue(r).isComponents,before:b},{code:p(({row:n})=>[Q(n)?(C(),x(g,{key:0,type:"danger"},{default:p(()=>t[3]||(t[3]=[$("已过期")])),_:1,__:[3]})):E("",!0),$(" "+ie(n.name),1)]),_:1},8,["columns","control-btn","auto-load"]),f(te,{modelValue:_.value,"onUpdate:modelValue":t[2]||(t[2]=n=>_.value=n),width:"800",title:q.value,class:"form-dialog","before-close":P},{default:p(()=>[v.value?(C(),x(Z,{key:0,title:"审核通过，不能修改数据",type:"success"})):E("",!0),f(ee,{disabeld:v.value,pk:"id",ref_key:"formRef",ref:k,data:z.value,"label-width":"110",class:"flex-form flex-form-2",api:{detail:"contractGet",add:"contractSave",edit:"contractEdit"},onCancel:P,after:G,before:A,onChange:J,modelValue:d.value,"onUpdate:modelValue":t[1]||(t[1]=n=>d.value=n)},{files:p(({rows:n})=>[_.value?(C(),x(he,{key:0,rules:n.formItem.rules,prop:n.prop,label:n.label,modelValue:d.value.files,"onUpdate:modelValue":t[0]||(t[0]=ae=>d.value.files=ae)},null,8,["rules","prop","label","modelValue"])):E("",!0)]),_:1},8,["disabeld","data","modelValue"])]),_:1},8,["modelValue","title"]),f(fe,{ref_key:"paymentFormRef",ref:w,onCallback:K},null,512)],64)}}});export{he as _,ye as a};
