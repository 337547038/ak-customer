import{_ as L}from"./index.vue_vue_type_script_setup_true_lang-_AmnQ_dk.js";import{d as S,l as r,m as K,M as Q,e as C,o as I,r as d,g as m,h as p,i as X,D as P,E as Z,z as $,k as ee,s as N,I as q,L as U,c as te,N as ae,F as le,f as E,v as B,t as oe}from"./index-CJ8aW7xe.js";import{v as i}from"./validate-BQpdx7O0.js";import{_ as re}from"./selectContact.vue_vue_type_script_setup_true_lang-m3T1-wYp.js";import{_ as se}from"./paymentForm.vue_vue_type_script_setup_true_lang-DdCrYLi6.js";const ne=["src"],ue=S({__name:"upload",props:{modelValue:{default:""}},emits:["update:modelValue"],setup(Y,{emit:x}){const u=Y,k=x,o=r([]),f=r(""),_=r(!1),g=K(()=>u.modelValue,()=>{if(u.modelValue){const l=u.modelValue.split(",");o.value=[],l.forEach(a=>{o.value.push({url:a})})}}),b=()=>{$(()=>{const l=o.value.length?o.value.map(a=>a.url).join(","):"";k("update:modelValue",l)})},D=l=>{P("uploadDel",{path:l.url}),b()},F=l=>{f.value=l.url,_.value=!0},M=l=>{const a=new FormData;a.append("file",l.file),P("upload",a).then(({data:c})=>{o.value.forEach(s=>{s.uid===l.file?.uid&&(s.url=c)}),b()}).catch(()=>{o.value.forEach((c,s)=>{c.uid===l.file?.uid&&o.value.splice(s,1)}),b(),Z.error(`${l.file.name}上传失败`)})};return Q(()=>{g()}),(l,a)=>{const c=d("Plus"),s=d("el-icon"),v=d("el-upload"),w=d("el-dialog"),V=d("el-form-item");return I(),C(V,{style:{width:"100%"}},{default:m(()=>[p(v,{"file-list":o.value,"onUpdate:fileList":a[0]||(a[0]=y=>o.value=y),"http-request":M,"list-type":"picture-card","on-preview":F,"on-remove":D},{default:m(()=>[p(s,null,{default:m(()=>[p(c)]),_:1})]),_:1},8,["file-list"]),p(w,{modelValue:_.value,"onUpdate:modelValue":a[1]||(a[1]=y=>_.value=y)},{default:m(()=>[X("img",{"w-full":"",src:f.value,alt:"Preview Image"},null,8,ne)]),_:1},8,["modelValue"])]),_:1})}}}),ve=S({__name:"index",props:{isComponents:{type:Boolean},cId:{}},setup(Y,{expose:x}){const u=Y,k=ee(),o=r(!1),f=r(),_=N(()=>u.isComponents?u.tabsName==="contract":k.userInfo?.hasChild),g=N(()=>!u.isComponents),b=r(),D=r(),F=r([{label:"所属人员",prop:"userId",show:!1,search:{changeRefresh:!0,style:{width:"230px"},visible:_,render:"select",ajax:{api:"userChildList",data:{},label:"userName",value:"id"},clearable:!0}},{prop:"id",label:"ID",search:!1,width:50},{prop:"code",label:"合同编号"},{prop:"name",label:"合同名称"},{prop:"customerId",label:"客户名称",width:180,showOverflowTooltip:!0,formatter:e=>e.customerName,search:{render:"component",userId:D,visible:g,component:q(L)},show:g},{prop:"money",label:"合同金额",search:!1,width:110},{prop:"payment",label:"已收款项",search:!1,width:110},{prop:"contactId",label:"公司签约人",search:!1,formatter:e=>e.contactName,width:100},{prop:"startDate",label:"合同有效期",search:{render:"datePicker",type:"daterange",startPlaceholder:"开始时间",endPlaceholder:"结束时间",valueFormat:"YYYY-MM-DD"},formatter:e=>U(e.startDate,"{y}-{m}-{d}")+" / "+U(e.endDate,"{y}-{m}-{d}"),width:180},{prop:"creatDate",label:"创建时间",render:"date",search:!1,width:100},{prop:"status",label:"状态",render:"tag",replaceValue:{1:"待审核",2:"已确认",3:"未通过"},custom:{2:"success",3:"danger"},search:{render:"select",options:{1:"待审核",2:"已确认",3:"未通过"}},width:"90px"},{prop:"operate",label:"操作",render:"buttons",width:180,fixed:"right",buttons:[{label:"收款",attr:{type:"success",text:!0},click:e=>{b.value.open(!1,e)}},{key:"edit",label:"详情",attr:{text:!0},click:e=>{c(e)}},{key:"del",label:"删除",attr:{text:!0}}],search:!1}]),M=(e,t,h)=>{e==="userId"&&k.userInfo?.hasChild&&(h.customerId=null,D.value=t)},l=(e,t)=>(e==="get"&&(t.startEndDate&&(t.startDate=t.startEndDate[0],t.endDate=t.startEndDate[1],delete t.startEndDate),u.cId&&(t.customerId=u.cId)),t),a=r(!1),c=e=>{o.value=!1,a.value=!0,e&&(w.value="修改合同",$(()=>{D.value||(o.value=e.status===2),s.value.getData({id:e.id})}))},s=r(),v=r({}),w=r("新增合同"),V=r(),y=r([{label:"客户名称",prop:"customerId",render:"component",component:q(L),visible:g,formItem:{rules:[i("required","客户名称不能为空","change")]}},{label:"合同名称",prop:"name",formItem:{rules:[i("required","合同名称不能为空","change")]}},{label:"合同编码",prop:"code",formItem:{rules:[i("required","合同编码不能为空","change")]}},{label:"公司签约人",prop:"contactId",attr:{placeholder:"请输入联系人,可使用%",customerId:V},render:"component",component:q(re),formItem:{rules:[i("required","公司签约人不能为空","change")]}},{label:"合同金额",prop:"money",formItem:{rules:[i("required","合同金额不能为空","change"),i("money")]}},{label:"合同开始时间",prop:"startDate",render:"datePicker",attr:{valueFormat:"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD"},formItem:{rules:[i("required","合同开始时间不能为空","change")]}},{label:"合同结束时间",prop:"endDate",render:"datePicker",attr:{valueFormat:"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD"},formItem:{rules:[i("required","合同结束时间不能为空","change")]}},{label:"备注",prop:"remark",attr:{style:{width:"100%"},type:"textarea",rows:4}},{prop:"files",label:"合同附件",render:"scope",formItem:{rules:[{required:!0,message:"请输入合同附件"}]}}]),R=()=>{a.value=!1,v.value={},s.value.resetFields()},H=(e,t)=>e,T=(e,t,h)=>(["add","update"].includes(h)&&(R(),f.value.getData()),e),j=(e,t,h)=>{e==="customerId"&&(h.contactId=null,V.value=t)},z=()=>{f.value.getData()},A=e=>e.startDate<new Date&&e.endDate>new Date;return x({getData:()=>{f.value.getData()}}),(e,t)=>{const h=d("el-tag"),G=d("el-alert"),O=d("ak-form"),W=d("el-dialog");return I(),te(le,null,[p(ae,{ref_key:"tableListRef",ref:f,pk:"id",columns:F.value,api:{list:"contractList",del:"contractDel"},"control-btn":[{key:"add",click:()=>{c()}}],onFormFieldChange:M,"auto-load":!e.isComponents,before:l},{code:m(({row:n})=>[A(n)?(I(),C(h,{key:0,type:"danger"},{default:m(()=>t[3]||(t[3]=[B("已过期")])),_:1,__:[3]})):E("",!0),B(" "+oe(n.name),1)]),_:1},8,["columns","control-btn","auto-load"]),p(W,{modelValue:a.value,"onUpdate:modelValue":t[2]||(t[2]=n=>a.value=n),width:"800",title:w.value,class:"form-dialog","before-close":R},{default:m(()=>[o.value?(I(),C(G,{key:0,title:"审核通过，不能修改数据",type:"success"})):E("",!0),p(O,{disabeld:o.value,pk:"id",ref_key:"formRef",ref:s,data:y.value,"label-width":"110",class:"flex-form flex-form-2",api:{detail:"contractGet",add:"contractSave",edit:"contractEdit"},onCancel:R,after:T,before:H,onChange:j,modelValue:v.value,"onUpdate:modelValue":t[1]||(t[1]=n=>v.value=n)},{files:m(({rows:n})=>[a.value?(I(),C(ue,{key:0,rules:n.formItem.rules,prop:n.prop,label:n.label,modelValue:v.value.files,"onUpdate:modelValue":t[0]||(t[0]=J=>v.value.files=J)},null,8,["rules","prop","label","modelValue"])):E("",!0)]),_:1},8,["disabeld","data","modelValue"])]),_:1},8,["modelValue","title"]),p(se,{ref_key:"paymentFormRef",ref:b,onCallback:z},null,512)],64)}}});export{ue as _,ve as a};
