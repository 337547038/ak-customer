import{_ as T}from"./index.vue_vue_type_script_setup_true_lang-CvW6n_1L.js";import{d as W,E as l,l as A,a2 as G,e as x,o as k,r as c,g as i,h as m,n as Y,U as re,i as oe,R as B,T as se,J,a6 as ne,k as ue,q as $,Q as N,S as j,c as de,a7 as ce,F as ie,f as S,x as H,t as me,j as pe}from"./index-DuawtOAE.js";import{v as d}from"./validate-DWWidr2n.js";import{_ as fe}from"./index.vue_vue_type_script_setup_true_lang-D-Hmp8yO.js";import{_ as ve}from"./paymentForm.vue_vue_type_script_setup_true_lang-BMtCb2Sa.js";const he=["src"],be=W({__name:"upload",props:{modelValue:{default:""}},emits:["update:modelValue"],setup(F,{emit:q}){const a=F,C=q,o=l([]),p=l(""),f=l(!1),M=A(()=>a.modelValue,()=>{if(a.modelValue){const r=a.modelValue.split(",");o.value=[],r.forEach(s=>{o.value.push({url:s})})}}),v=()=>{J(()=>{const r=o.value.length?o.value.map(s=>s.url).join(","):"";C("update:modelValue",r)})},V=r=>{B("uploadDel",{path:r.url}),v()},I=r=>{p.value=r.url,f.value=!0},y=r=>{const s=new FormData;s.append("file",r.file),B("upload",s).then(({data:h})=>{o.value.forEach(u=>{u.uid===r.file?.uid&&(u.url=h)}),v()}).catch(()=>{o.value.forEach((h,u)=>{h.uid===r.file?.uid&&o.value.splice(u,1)}),v(),se.error(`${r.file.name}上传失败`)})};return G(()=>{M()}),(r,s)=>{const h=c("el-icon"),u=c("el-upload"),w=c("el-dialog"),b=c("el-form-item");return k(),x(b,{style:{width:"100%"}},{default:i(()=>[m(u,{"file-list":o.value,"onUpdate:fileList":s[0]||(s[0]=_=>o.value=_),"http-request":y,"list-type":"picture-card","on-preview":I,"on-remove":V},{default:i(()=>[m(h,null,{default:i(()=>[m(Y(re))]),_:1})]),_:1},8,["file-list"]),m(w,{modelValue:f.value,"onUpdate:modelValue":s[1]||(s[1]=_=>f.value=_)},{default:i(()=>[oe("img",{"w-full":"",src:p.value,alt:"Preview Image"},null,8,he)]),_:1},8,["modelValue"])]),_:1})}}}),ke=W({__name:"index",props:{keyColumns:{default:""}},setup(F,{expose:q}){const a=ne("detailTabsProps",l({})),C=pe(),o=ue(),p=l(!1),f=l(),M=$(()=>a.value.isComponents?a.value.tabsName==="child":o.userInfo?.hasChild),v=$(()=>!a.value.isComponents),V=l(),I=l(),y=l(),r=[{key:"add",click:()=>{_()},display:()=>!a.value.disabled}],s=l([{label:"所属人员",prop:"userId",visible:!1,search:{changeRefresh:!0,style:{width:"230px"},visible:M,render:"select",ajax:{api:"userChildList",data:{},label:"userName",value:"id"},clearable:!0}},{prop:"id",label:"ID",search:!1,width:50},{prop:"code",label:"合同编号"},{prop:"name",label:"合同名称"},{prop:"customerId",label:"客户名称",width:180,showOverflowTooltip:!0,formatter:e=>e.customerName,search:{render:"component",userId:I,visible:v,component:N(T)},visible:v},{prop:"money",label:"合同金额",search:!1,width:110},{prop:"payment",label:"已收款项",search:!1,width:110},{prop:"contactId",label:"公司签约人",search:!1,formatter:e=>e.contactName,width:100},{prop:"startDate",label:"合同有效期",search:{render:"datePicker",type:"daterange",startPlaceholder:"开始时间",endPlaceholder:"结束时间",valueFormat:"YYYY-MM-DD"},formatter:e=>j(e.startDate,"{y}-{m}-{d}")+" / "+j(e.endDate,"{y}-{m}-{d}"),width:180},{prop:"creatDate",label:"创建时间",render:"date",search:!1,width:100},{prop:"status",label:"状态",render:"tag",replaceValue:{1:"待审核",2:"已确认",3:"未通过"},custom:{2:"success",3:"danger"},search:{render:"select",options:{1:"待审核",2:"已确认",3:"未通过"}},width:"90px"},{visible:()=>!a.value.disabled,prop:"operate",label:"操作",render:"buttons",width:210,fixed:"right",buttons:[{label:"审核",attr:{type:"danger",text:!0},display:e=>o.userInfo?.hasChild&&e.userId!==o.userInfo?.id&&e.status===1,click:e=>{_(e,!0)}},{label:"收款",attr:{type:"success",text:!0},click:e=>{V.value.open(!1,e)}},{key:"edit",label:"详情",attr:{text:!0},click:e=>{_(e)}},{key:"del",label:"删除",attr:{text:!0}}],search:!1}]),h=(e,t,g)=>{e==="userId"&&o.userInfo?.hasChild&&(g.customerId=null,I.value=t)},u=(e,t)=>(e==="get"&&(t.startEndDate&&(t.startDate=t.startEndDate[0],t.endDate=t.startEndDate[1],delete t.startEndDate),a.value.customerId&&(t.customerId=a.value.customerId),t.userId=a.value.userId,C.query.search==="todo"&&(t.extend.search="child"),a.value.tabsName==="shareWithMe"&&(t.specialCustomer=a.value.customerId,t.extend.search="comInvalidShare")),t),w=l(!1),b=l(!1),_=(e,t)=>{p.value=!1,b.value=!0,E.value="新增合同",e&&(E.value=t?"审批合同":"修改合同",w.value=!!t,J(()=>{I.value||(p.value=e.status===2),y.value=e.userId,R.value.getData({id:e.id}),L.value=e.customerId}))},R=l(),D=l({}),E=l("新增合同"),L=l(),O=l([{label:"客户名称",prop:"customerId",render:"component",component:N(T),visible:v,formItem:{rules:[d("required","客户名称不能为空","change")]},attr:{userId:y}},{label:"合同名称",prop:"name",formItem:{rules:[d("required","合同名称不能为空","change")]}},{label:"合同编码",prop:"code",formItem:{rules:[d("required","合同编码不能为空","change")]}},{label:"公司签约人",prop:"contactId",attr:{placeholder:"请输入联系人,可使用%",customerId:L,userId:y},render:"component",component:N(fe),formItem:{rules:[d("required","公司签约人不能为空","change")]}},{label:"合同金额",prop:"money",formItem:{rules:[d("required","合同金额不能为空","change"),d("money")]}},{label:"合同开始时间",prop:"startDate",render:"datePicker",attr:{valueFormat:"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD"},formItem:{rules:[d("required","合同开始时间不能为空","change")]}},{label:"合同结束时间",prop:"endDate",render:"datePicker",attr:{valueFormat:"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD"},formItem:{rules:[d("required","合同结束时间不能为空","change")]}},{label:"审核",prop:"status",render:"select",options:[{value:1,label:"待审核"},{value:2,label:"通过"},{value:3,label:"拒绝"}],visible:w},{label:"备注",prop:"remark",attr:{style:{width:"100%"},type:"textarea",rows:4}},{prop:"files",label:"合同附件",render:"scope",formItem:{rules:[{required:!0,message:"请输入合同附件"}]}}]),P=()=>{b.value=!1,D.value={},R.value.resetFields()},Q=(e,t)=>(t==="add"&&a.value.isComponents&&(e.customerId=a.value.customerId),e),z=(e,t,g)=>(["add","update"].includes(g)&&(P(),f.value.getData()),e),K=(e,t,g)=>{e==="customerId"&&(g.contactId=null,L.value=t)},X=e=>e.startDate<new Date&&e.endDate>new Date,U=()=>{f.value.getData()},Z=A(()=>C.query,()=>{U()});return G(()=>{Z()}),q({getData:U}),(e,t)=>{const g=c("el-tag"),ee=c("el-alert"),te=c("ak-form"),ae=c("el-dialog");return k(),de(ie,null,[m(ce,{ref_key:"tableListRef",ref:f,pk:"id",columns:s.value,"show-search":!Y(a).disabled,api:{list:"contractList",del:"contractDel"},"control-btn":r,"auto-load":!Y(a).isComponents,"columns-icon-visible":!Y(a).disabled,"key-columns":F.keyColumns,before:u,onFormFieldChange:h},{code:i(({row:n})=>[X(n)?(k(),x(g,{key:0,type:"danger"},{default:i(()=>[...t[3]||(t[3]=[H(" 已过期 ",-1)])]),_:1})):S("",!0),H(" "+me(n.name),1)]),_:1},8,["columns","show-search","auto-load","columns-icon-visible","key-columns"]),m(ae,{modelValue:b.value,"onUpdate:modelValue":t[2]||(t[2]=n=>b.value=n),width:"800",title:E.value,class:"form-dialog","before-close":P},{default:i(()=>[p.value?(k(),x(ee,{key:0,title:"审核通过，不能修改数据",type:"success"})):S("",!0),m(te,{ref_key:"formRef",ref:R,modelValue:D.value,"onUpdate:modelValue":t[1]||(t[1]=n=>D.value=n),disabeld:p.value,pk:"id",data:O.value,"label-width":"110",class:"flex-form flex-form-2",api:{detail:"contractGet",add:"contractSave",edit:"contractEdit"},after:z,before:Q,onCancel:P,onChange:K},{files:i(({rows:n})=>[b.value?(k(),x(be,{key:0,modelValue:D.value.files,"onUpdate:modelValue":t[0]||(t[0]=le=>D.value.files=le),rules:n.formItem.rules,prop:n.prop,label:n.label},null,8,["modelValue","rules","prop","label"])):S("",!0)]),_:1},8,["modelValue","disabeld","data"])]),_:1},8,["modelValue","title"]),m(ve,{ref_key:"paymentFormRef",ref:V,onCallback:U},null,512)],64)}}});export{be as _,ke as a};
