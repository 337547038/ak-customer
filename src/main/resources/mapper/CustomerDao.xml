<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="customer.dao.CustomerDao">

    <resultMap type="customer.entity.Customer" id="CustomerMap">
        <result property="id" column="id" jdbcType="INTEGER"/>
        <result property="company" column="company" jdbcType="VARCHAR"/>
        <result property="brandName" column="brandName" jdbcType="VARCHAR"/>
        <result property="type" column="type" jdbcType="INTEGER"/>
        <result property="area" column="area" jdbcType="VARCHAR"/>
        <result property="address" column="address" jdbcType="VARCHAR"/>
        <result property="industry" column="industry" jdbcType="INTEGER"/>
        <result property="code" column="code" jdbcType="VARCHAR"/>
        <result property="files" column="files" jdbcType="VARCHAR"/>
        <result property="source" column="source" jdbcType="INTEGER"/>
        <result property="tel" column="tel" jdbcType="VARCHAR"/>
        <result property="web" column="web" jdbcType="VARCHAR"/>
        <result property="userId" column="userId" jdbcType="INTEGER"/>
        <result property="creatTime" column="creatTime" jdbcType="TIMESTAMP"/>
        <result property="updateTime" column="updateTime" jdbcType="TIMESTAMP"/>
        <result property="remark" column="remark" jdbcType="VARCHAR"/>
        <result property="status" column="status" jdbcType="INTEGER"/>
        <result property="shareUserId" column="shareUserId" jdbcType="VARCHAR"/>
    </resultMap>

    <sql id="commColumnsItem">
        id
        , company, brandName, type, area, address, industry, code, files, source, tel, web, userId, creatTime, updateTime, remark, status, shareUserId
    </sql>
    <!--查询单个-->
    <select id="queryById" resultMap="CustomerMap">
        select
        <include refid="commColumnsItem"/>
        from sys_customer
        where id = #{id}
    </select>
    <sql id="queryListWhere">
        <bind name="andOr" value="extend.search=='check' ? 'or' : 'and'"/>
        <if test="query.id != null">
            and a.id = #{query.id}
        </if>
        <if test="query.userId != null">
            and a.userId = #{query.userId}
        </if>
        <!--查看下属-->
        <if test="extend.search=='child' and extend.userIds!=null">
            and a.userId in
            <foreach collection="extend.userIds" item="item" separator="," open="(" close=")">
                #{item}
            </foreach>
        </if>

        <if test="query.company != null and query.company != ''">
            ${andOr} a.company LIKE CONCAT('%', #{query.company}, '%')
        </if>
        <if test="query.brandName != null and query.brandName != ''">
            ${andOr} a.brandName LIKE CONCAT('%', #{query.brandName}, '%')
        </if>
        <if test="query.type != null">
            and type = #{query.type}
        </if>
        <if test="query.area != null and query.area != ''">
            and a.area = #{query.area}
        </if>
        <if test="query.address != null and query.address != ''">
            and a.address = #{query.address}
        </if>
        <if test="query.industry != null">
            and a.industry = #{query.industry}
        </if>
        <if test="query.code != null and query.code != ''">
            ${andOr} a.code LIKE CONCAT('%', #{query.code}, '%')
        </if>

        <if test="query.source != null">
            and a.source = #{query.source}
        </if>
        <if test="query.tel != null and query.tel != ''">
            ${andOr} a.tel LIKE CONCAT('%', #{query.tel}, '%')
        </if>
        <if test="query.status != null">
            and a.status = #{query.status}
        </if>
        <if test="extend.search=='myShare'">
            and a.shareUserId is not null and a.shareUserId != ''
        </if>
        <if test="extend.search=='shareWithMe'">
            and FIND_IN_SET(#{query.shareUserId}, a.shareUserId) > 0 or a.shareUserId="0"
        </if>
    </sql>
    <!--查询指定行数据-->
    <select id="queryAllByLimit">
        select
        <choose>
            <when test="extend.columns=='diy' and extend.diyColumns!=null and extend.diyColumns!=''">
                <foreach collection="extend.diyColumns" item="item" separator=",">
                    a.${item}
                </foreach>
            </when>
            <otherwise>
                a.id, a.company, a.brandName, a.type, a.area, a.address, a.industry, a.code, a.source, a.tel, a.userId, a.creatTime, a.updateTime,a.status,a.shareUserId
            </otherwise>
        </choose>
        <if test="extend.columns=='user'">
            ,c.userName
        </if>
        <if test="extend.columns=='contact'">
            ,c.userName,b.lastTime,b.nextTime
        </if>
        from sys_customer as a
        <if test="extend.columns=='user'">
            join `sys_user` as c ON a.userId=c.id
        </if>
        <if test="extend.columns=='contact'">
            join `sys_user` as c ON a.userId=c.id
            left join (SELECT tid,lastTime,nextTime,MAX(nextTime) FROM `sys_contact` GROUP BY tid) as b
            ON a.id=b.tid
        </if>
        <where>
            <include refid="queryListWhere"/>
        </where>
        <choose>
            <when test="extend.sort != null and extend.sort!=''">
                order by ${extend.sort}
            </when>
            <when test="extend.columns=='contact'">
                order by b.nextTime
            </when>
            <otherwise>
                order by a.id desc
            </otherwise>
        </choose>
        <if test="extend.pageSize >0">
            limit #{extend.pageIndex}, #{extend.pageSize}
        </if>
    </select>

    <!--统计总行数-->
    <select id="count" resultType="java.lang.Long">
        select count(1)
        from sys_customer as a
        <if test="extend.columns=='user'">
            join `sys_user` as c ON a.userId=c.id
        </if>
        <if test="extend.columns=='contact'">
            join `sys_user` as c ON a.userId=c.id
        </if>
        <where>
            <include refid="queryListWhere"/>
        </where>
    </select>

    <select id="exist">
        select c.id,c.company,c.code,c.userId,u.userName
        from sys_customer as c
        left join sys_user as u on u.id=c.userId
        <where>
            <if test="id != null">
                and c.id != #{id}
            </if>
            <if test="company != null and company != ''">
                and c.company = #{company}
            </if>
            <if test="code != null and code != ''">
                and c.code = #{code}
            </if>
            <if test="userId != null">
                and c.userId = #{userId}
            </if>
        </where>
    </select>

    <!--新增所有列-->
    <insert id="insert" keyProperty="id" useGeneratedKeys="true">
        insert into sys_customer(company, brandName, type, area, address, industry, code, files, source, tel, web, userId, creatTime, updateTime, remark, status, shareUserId)
        values (#{company}, #{brandName}, #{type}, #{area}, #{address}, #{industry}, #{code}, #{files}, #{source}, #{tel}, #{web}, #{userId}, #{creatTime}, #{updateTime}, #{remark}, #{status}, #{shareUserId})
    </insert>

    <!--通过主键修改数据-->
    <update id="updateById">
        update sys_customer
        <set>
            <if test="company != null and company != ''">
                company = #{company},
            </if>
            <if test="brandName != null and brandName != ''">
                brandName = #{brandName},
            </if>
            <if test="type != null">
                type = #{type},
            </if>
            <if test="area != null and area != ''">
                area = #{area},
            </if>
            <if test="address != null and address != ''">
                address = #{address},
            </if>
            <if test="industry != null">
                industry = #{industry},
            </if>
            <if test="code != null and code != ''">
                code = #{code},
            </if>
            <if test="files != null and files != ''">
                files = #{files},
            </if>
            <if test="source != null">
                source = #{source},
            </if>
            <if test="tel != null and tel != ''">
                tel = #{tel},
            </if>
            <if test="web != null and web != ''">
                web = #{web},
            </if>
            <if test="updateTime != null">
                updateTime = #{updateTime},
            </if>
            <if test="remark != null and remark != ''">
                remark = #{remark},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="shareUserId != null and shareUserId != '' and shareUserId != 'cancel'">
                shareUserId = #{shareUserId},
            </if>
            <if test="shareUserId == 'cancel'">
                shareUserId = "",
            </if>
        </set>
        <where>
            id = #{id}
            <if test="userId!=null">
                and userId = #{userId}
            </if>
        </where>
    </update>

    <update id="moveCustomerByIds">
        update sys_customer
        <set>
            <if test="type=='toCom'">
                userId=null,status=2,shareUserId=''
            </if>
            <if test="type=='toUser'">
                userId=#{params.userId},shareUserId=''
            </if>
            <if test="type=='toInvalid'">
                userId=null,status=3,shareUserId=''
            </if>
            <if test="type=='toFollow'">
                userId=#{params.userId},status=1
            </if>
            <if test="type=='toShare'">
                shareUserId=#{params.userId}
            </if>
        </set>
        <where>
            id in (${params.ids})
            <!--以下操作添加权限，保证操作是自己或下属的客户-->
            <if test="type!='toFollow' and params.hasUserIds!=null">
                and (userId=#{params.currentId} or userId in
                <foreach collection="params.hasUserIds" item="item" separator="," open="(" close=")">
                    #{item}
                </foreach>
                )
            </if>
        </where>
    </update>

    <!--通过主键删除，必须为公海或无效客户才能删除-->
    <delete id="deleteById">
        delete
        from sys_customer where (status=2 or status=3) and id in
        <foreach collection="id" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
    </delete>

    <!--根据主键查询当前登录用户是否有操作权限-->
    <select id="hasCount" resultType="java.lang.Long">
        select count(1)
        from sys_customer where id=#{query.id} and (userId=#{query.userId}
        or (userId is null and (status=2 or status=3))
        or userId in
        <foreach collection="query.userIds" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
        <!--查看时添加共享条件-->
        <if test="query.search=='detail'">
            or FIND_IN_SET(#{query.userId}, shareUserId) > 0 or shareUserId="0"
        </if>
        )
    </select>
    <!--查询超过30天无跟进记录的客户-->
    <select id="queryNotFollowRecords">
        SELECT a.id,
               a.company,
               (SELECT MAX(datetime) FROM sys_follow_records WHERE customerId = a.id) AS lastFollowDate
        FROM sys_customer a where a.userId=#{userId}
        HAVING lastFollowDate IS NULL
            OR DATE_SUB(CURDATE(), INTERVAL 30 DAY) >= lastFollowDate
        limit 0 ,10
    </select>
    <select id="queryContactBirthday">
        SELECT
        a.id,
        a.company,
        b.name AS contactName,
        b.birthday
        FROM
        sys_customer a
        JOIN
        sys_contact b ON a.id = b.tid
        WHERE a.userId=#{userId} and
        -- 计算今年生日的日期是否在未来7天内
        -- 计算今年生日的日期是否在未来7天内
        (DAYOFYEAR(b.birthday) >= DAYOFYEAR(CURDATE()) AND
        DAYOFYEAR(b.birthday) &lt;= DAYOFYEAR(DATE_ADD(CURDATE(), INTERVAL 7 DAY)))
        -- 或者明年生日的日期（处理跨年情况）
        OR (DAYOFYEAR(CURDATE()) > DAYOFYEAR(DATE_SUB(DATE_ADD(CURDATE(), INTERVAL 7 DAY), INTERVAL 1 YEAR)) AND
        DAYOFYEAR(b.birthday) &lt;= DAYOFYEAR(DATE_ADD(CURDATE(), INTERVAL 7 DAY)) - 365)
        ORDER BY
        CASE
        WHEN DAYOFYEAR(b.birthday) >= DAYOFYEAR(CURDATE())
        THEN DAYOFYEAR(b.birthday) - DAYOFYEAR(CURDATE())
        ELSE 365 - DAYOFYEAR(CURDATE()) + DAYOFYEAR(b.birthday)
        END
        LIMIT 0,10
    </select>

</mapper>
